# ==============================================================================
# LTX-2 Video Generation Container
# ==============================================================================
# Production-ready Dockerfile for vllm-omni with LTX-2 support.
#
# Key Features:
# - Works with podman's --userns=keep-id (auto-maps host user)
# - No hardcoded usernames or UIDs
# - Writable workspace for any user
# - Cache directories in /tmp (no permission issues)
#
# Build:
#   podman build -t vllm-omni:ltx2 -f docker/Dockerfile.ltx2 .
#
# Run with podman (recommended):
#   podman run --rm --device nvidia.com/gpu=0 \
#     --userns=keep-id \
#     -v /path/to/hf/cache:/hf/hub \
#     -v /path/to/output:/output \
#     -e HF_TOKEN=hf_... \
#     -e HUGGINGFACE_HUB_CACHE=/hf/hub \
#     vllm-omni:ltx2 \
#     python examples/offline_inference/text_to_video_ltx2.py \
#       --model Lightricks/LTX-2 \
#       --prompt "A cat playing with a ball" \
#       --output /output/video.mp4
# ==============================================================================

ARG VLLM_BASE_IMAGE=vllm/vllm-openai
ARG VLLM_BASE_TAG=v0.12.0
FROM ${VLLM_BASE_IMAGE}:${VLLM_BASE_TAG}

ARG APP_DIR=/workspace/vllm-omni
WORKDIR ${APP_DIR}

# Copy source code
COPY . .

# Install vllm-omni and LTX-2 dependencies
RUN uv pip install --python "$(python3 -c 'import sys; print(sys.executable)')" --no-cache-dir ".[dev]" && \
    uv pip install --python "$(python3 -c 'import sys; print(sys.executable)')" --no-cache-dir -e references/LTX-2/packages/ltx-core && \
    uv pip install --python "$(python3 -c 'import sys; print(sys.executable)')" --no-cache-dir -e references/LTX-2/packages/ltx-pipelines && \
    ln -sf /usr/bin/python3 /usr/bin/python

# Make workspace writable by any user (for podman --userns=keep-id)
RUN chmod -R 777 ${APP_DIR}

# Set cache directory defaults (can be overridden at runtime)
# These work with podman's --userns=keep-id which auto-maps host user
ENV HF_HOME=/tmp/hf \
    HUGGINGFACE_HUB_CACHE=/tmp/hf/hub \
    TRANSFORMERS_CACHE=/tmp/hf/hub

ENTRYPOINT []
